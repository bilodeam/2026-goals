<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TeamGoals 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:#f8fafc;min-height:100vh}
button{cursor:pointer;border:none;background:none;font-family:inherit}
input{font-family:inherit}
table{border-collapse:collapse;width:100%}

.page{display:none;min-height:100vh}
.page.active{display:block}

/* Welcome */
#welcome{background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);display:flex;flex-direction:column}
.welcome-header{padding:24px 32px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:40px;height:40px;background:#fbbf24;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{color:#fff;font-weight:700;font-size:18px;line-height:1.2}
.logo-sub{color:#94a3b8;font-size:12px}
.manager-link{color:#475569;font-size:12px;cursor:pointer;background:none;border:none;transition:color 0.2s}
.manager-link:hover{color:#94a3b8}
.welcome-hero{flex:1;display:flex;align-items:center;justify-content:center;padding:48px 16px}
.welcome-inner{max-width:512px;width:100%;text-align:center}
.badge{display:inline-flex;align-items:center;gap:8px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);border-radius:9999px;padding:6px 16px;margin-bottom:24px}
.badge span{color:#fbbf24;font-size:14px;font-weight:600}
.welcome-title{font-family:'Playfair Display',serif;font-size:48px;font-weight:900;color:#fff;margin-bottom:16px;line-height:1.1}
.welcome-title .accent{color:#fbbf24}
.welcome-desc{color:#94a3b8;font-size:18px;margin-bottom:40px;line-height:1.6}
.steps-preview{display:flex;justify-content:center;gap:24px;margin-bottom:40px}
.step-item{display:flex;flex-direction:column;align-items:center;gap:8px}
.step-num{width:40px;height:40px;background:rgba(251,191,36,0.2);border:1px solid rgba(251,191,36,0.3);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fbbf24;font-weight:700;font-size:14px}
.step-label{color:#94a3b8;font-size:12px}
.name-box{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;text-align:left;margin-bottom:16px}
.name-label{color:#cbd5e1;font-size:14px;font-weight:600;display:block;margin-bottom:8px}
.name-input{width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:12px;padding:12px 16px;color:#fff;font-size:16px;outline:none;transition:border-color 0.2s}
.name-input:focus{border-color:rgba(251,191,36,0.6)}
.name-input::placeholder{color:#64748b}
.btn-primary{width:100%;padding:16px;border-radius:16px;font-weight:700;font-size:18px;border:none;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;background:linear-gradient(135deg,#fbbf24,#d97706);color:#0f172a;cursor:pointer}
.btn-primary:disabled{background:#334155;color:#64748b;cursor:not-allowed;opacity:0.6}

/* Top nav */
.topnav{background:#0f172a;padding:12px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
.nav-logo{display:flex;align-items:center;gap:12px}
.nav-logo-icon{width:32px;height:32px;background:#fbbf24;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.nav-logo-text{color:#fff;font-weight:700}
.nav-greeting{color:#94a3b8;font-size:14px}
.nav-greeting span{color:#fbbf24;font-weight:600}

/* Step bar */
.stepbar{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px 0}
.step-pill{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:9999px;font-size:12px;font-weight:600;transition:all 0.2s}
.step-pill.active{background:#fbbf24;color:#0f172a}
.step-pill.done{background:#fbbf24;color:#0f172a}
.step-pill.inactive{background:#e2e8f0;color:#94a3b8}
.step-dot{width:16px;height:16px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}
.step-dot.active{background:#0f172a;color:#fbbf24}
.step-dot.done{background:#0f172a;color:#fbbf24}
.step-dot.inactive{background:#cbd5e1;color:#94a3b8}
.step-line{width:32px;height:2px;border-radius:2px;transition:background 0.3s}
.step-line.done{background:#fbbf24}
.step-line.inactive{background:#e2e8f0}

/* Selection page */
#select-page{background:#f8fafc}
.page-inner{max-width:1152px;margin:0 auto;padding:24px 16px}
.page-title{font-family:'Playfair Display',serif;font-size:30px;font-weight:900;color:#0f172a;margin-bottom:8px;text-align:center}
.page-sub{color:#64748b;text-align:center}
.select-all-btn{color:#d97706;font-size:14px;font-weight:600;text-decoration:underline;cursor:pointer;background:none;border:none;margin-top:8px;display:block;margin-left:auto;margin-right:auto}
.projects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;margin-bottom:120px;margin-top:24px}
.project-card{text-align:left;padding:12px 16px;border-radius:12px;border:2px solid #e2e8f0;background:#fff;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.15s;width:100%}
.project-card:hover{border-color:#cbd5e1;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.project-card.selected{border-color:#fbbf24;background:#fffbeb;box-shadow:0 4px 12px rgba(251,191,36,0.2)}
.project-emoji{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.project-title{font-weight:600;color:#0f172a;font-size:14px;flex:1;line-height:1.3;text-align:left}
.project-check{width:20px;height:20px;border-radius:9999px;border:2px solid #cbd5e1;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;color:#0f172a;transition:all 0.15s}
.project-check.checked{border-color:#fbbf24;background:#fbbf24}
.sticky-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e2e8f0;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 -4px 20px rgba(0,0,0,0.1);z-index:20}
.selected-count{color:#334155}
.selected-count strong{font-weight:900;font-size:24px;color:#0f172a}
.selected-count span{color:#64748b;font-size:14px;margin-left:4px}
.btn-continue{display:flex;align-items:center;gap:8px;padding:12px 24px;border-radius:12px;font-weight:700;font-size:14px;border:none;cursor:pointer;background:linear-gradient(135deg,#fbbf24,#d97706);color:#0f172a;transition:all 0.2s}
.btn-continue:disabled{background:#e2e8f0;color:#94a3b8;cursor:not-allowed}

/* Ranking page */
#rank-page{background:#f8fafc}
.progress-bar-wrap{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:16px;margin-bottom:24px;display:flex;align-items:center;gap:16px}
.progress-track{flex:1;background:#f1f5f9;border-radius:9999px;height:10px;overflow:hidden}
.progress-fill{height:100%;background:#fbbf24;border-radius:9999px;transition:width 0.5s ease}
.progress-text{font-size:14px;font-weight:600;color:#475569;white-space:nowrap}
.rating-cards{display:flex;flex-direction:column;gap:12px;margin-bottom:32px}
.rating-card{background:#fff;border-radius:16px;border:2px solid #e2e8f0;padding:20px;transition:border-color 0.2s}
.rating-card.rated{border-color:#fcd34d}
.rating-card-inner{display:flex;align-items:center;gap:16px}
.rating-emoji{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.rating-content{flex:1;min-width:0}
.rating-row{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.rating-title{font-weight:700;color:#0f172a;font-size:14px;line-height:1.3}
.rating-stars{display:flex;flex-direction:column;align-items:flex-end;gap:4;flex-shrink:0}
.stars{display:flex;gap:4px}
.star{font-size:28px;cursor:pointer;transition:transform 0.1s;color:#cbd5e1;background:none;border:none;line-height:1}
.star:hover,.star.lit{color:#fbbf24;transform:scale(1.2)}
.rating-label{font-size:12px;color:#d97706;font-weight:600}
.rating-label.empty{color:#94a3b8}
.rank-actions{display:flex;align-items:center;justify-content:space-between;gap:16px}
.btn-back{display:flex;align-items:center;gap:8px;padding:12px 20px;border-radius:12px;border:2px solid #e2e8f0;color:#475569;font-weight:600;font-size:14px;cursor:pointer;background:#fff;transition:all 0.2s}
.btn-back:hover{border-color:#cbd5e1;background:#f8fafc}
.btn-submit{display:flex;align-items:center;gap:8px;padding:12px 24px;border-radius:12px;font-weight:700;font-size:14px;border:none;cursor:pointer;background:linear-gradient(135deg,#fbbf24,#d97706);color:#0f172a;transition:all 0.2s}
.btn-submit:disabled{background:#e2e8f0;color:#94a3b8;cursor:not-allowed}
.rank-hint{text-align:center;color:#94a3b8;font-size:12px;margin-top:12px}

/* Confirmation */
#confirm-page{background:#f8fafc;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 16px}
.confirm-inner{max-width:512px;width:100%;text-align:center}
.confirm-check{width:80px;height:80px;background:#fbbf24;border-radius:9999px;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:36px}
.confirm-title{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;color:#0f172a;margin-bottom:8px}
.confirm-desc{color:#64748b;margin-bottom:32px}
.confirm-list{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:24px;text-align:left;margin-top:24px}
.confirm-list-title{font-weight:700;color:#64748b;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:16px}
.confirm-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 0}
.confirm-item-left{display:flex;align-items:center;gap:8px;min-width:0}
.confirm-item-emoji{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.confirm-item-title{font-weight:500;color:#1e293b;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.confirm-stars{display:flex;gap:2px;flex-shrink:0}
.confirm-star{font-size:14px}

/* Manager */
#manager-login{background:#0f172a;display:flex;align-items:center;justify-content:center;padding:16px}
.login-box{background:#fff;border-radius:24px;padding:32px;max-width:360px;width:100%;box-shadow:0 25px 50px rgba(0,0,0,0.5);text-align:center}
.login-icon{width:56px;height:56px;background:#0f172a;border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:24px}
.login-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:900;color:#0f172a;margin-bottom:4px}
.login-desc{color:#94a3b8;font-size:14px;margin-bottom:24px}
.login-input{width:100%;border:2px solid #e2e8f0;border-radius:12px;padding:12px 16px;margin-bottom:12px;font-size:14px;font-family:inherit;outline:none;color:#0f172a;transition:border-color 0.2s}
.login-input:focus{border-color:#fbbf24}
.login-error{color:#ef4444;font-size:12px;margin-bottom:12px}
.btn-login{width:100%;padding:12px;border-radius:12px;font-weight:700;font-size:14px;border:none;cursor:pointer;background:linear-gradient(135deg,#fbbf24,#d97706);color:#0f172a;margin-bottom:12px;transition:all 0.2s}
.btn-login:hover{opacity:0.9}
.btn-back-login{color:#94a3b8;font-size:14px;cursor:pointer;background:none;border:none;transition:color 0.2s}
.btn-back-login:hover{color:#64748b}

#manager-dash{background:#f8fafc}
.dash-header{background:#0f172a;padding:12px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
.dash-logo{display:flex;align-items:center;gap:12px}
.dash-logo-icon{width:32px;height:32px;background:#fbbf24;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.dash-logo-text{color:#fff;font-weight:700;line-height:1.2}
.dash-logo-sub{color:#94a3b8;font-size:12px}
.dash-actions{display:flex;align-items:center;gap:12px}
.btn-export{display:flex;align-items:center;gap:6px;background:#fbbf24;color:#0f172a;padding:8px 16px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;border:none;transition:opacity 0.2s}
.btn-export:hover{opacity:0.9}
.btn-exit{color:#94a3b8;font-size:14px;cursor:pointer;background:none;border:none;transition:color 0.2s}
.btn-exit:hover{color:#fff}
.dash-inner{max-width:1152px;margin:0 auto;padding:32px 16px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:20px}
.stat-card-top{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.stat-icon{width:36px;height:36px;background:#fef3c7;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.stat-label{color:#64748b;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
.stat-value{font-size:28px;font-weight:900;color:#0f172a;line-height:1}
.stat-sub{color:#94a3b8;font-size:12px;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.section-card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden;margin-bottom:24px}
.section-header{padding:16px 20px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;justify-content:space-between}
.section-title{font-weight:700;color:#1e293b;font-size:15px}
.sort-btns{display:flex;gap:8px}
.sort-btn{font-size:12px;padding:6px 12px;border-radius:8px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;background:#f1f5f9;color:#475569}
.sort-btn:hover{background:#e2e8f0}
.sort-btn.active{background:#0f172a;color:#fff}
.project-row{padding:16px 20px;display:flex;align-items:center;gap:16px;border-top:1px solid #f8fafc;transition:background 0.15s}
.project-row:hover{background:#f8fafc}
.project-rank{width:28px;height:28px;background:#f1f5f9;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#64748b;font-weight:700;font-size:12px;flex-shrink:0}
.project-row-emoji{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.project-row-info{flex:1;min-width:0}
.project-row-title{font-weight:600;color:#0f172a;font-size:14px}
.project-row-employees{color:#94a3b8;font-size:12px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.project-row-dist{display:flex;gap:8px;margin-top:4px}
.dist-item{font-size:11px;color:#94a3b8}
.project-row-stats{display:flex;gap:24px;flex-shrink:0}
.project-stat{text-align:center}
.project-stat-val{font-size:22px;font-weight:900;color:#0f172a;line-height:1}
.project-stat-val.amber{color:#d97706}
.project-stat-label{font-size:11px;color:#94a3b8;margin-top:2px}
.empty-state{background:#fff;border-radius:16px;border:1px solid #e2e8f0;padding:48px;text-align:center}
.empty-emoji{font-size:48px;margin-bottom:16px}
.empty-title{font-size:18px;font-weight:700;color:#475569;margin-bottom:8px}
.empty-desc{color:#94a3b8;font-size:14px}

/* Submissions list */
.sub-row{border-top:1px solid #f1f5f9;transition:background 0.15s}
.sub-row-header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.sub-row-header:hover{background:#fffbeb}
.sub-row-header.open{background:#fffbeb}
.sub-row-left{display:flex;align-items:center;gap:12px}
.sub-avatar{width:36px;height:36px;border-radius:9999px;background:linear-gradient(135deg,#fbbf24,#d97706);display:flex;align-items:center;justify-content:center;color:#0f172a;font-weight:700;font-size:14px;flex-shrink:0}
.sub-name{font-weight:700;color:#0f172a;font-size:14px}
.sub-meta{color:#94a3b8;font-size:12px;margin-top:2px}
.sub-row-right{display:flex;align-items:center;gap:12px}
.sub-arrow{color:#94a3b8;font-size:18px;transition:transform 0.2s}
.sub-arrow.open{transform:rotate(90deg)}
.btn-delete{background:#fee2e2;color:#ef4444;border:none;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;flex-shrink:0}
.btn-delete:hover{background:#fecaca;color:#dc2626}
.sub-detail{background:#fffbeb;border-top:1px solid #fcd34d;padding:20px 24px;display:none}
.sub-detail.open{display:block}
.sub-detail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
.sub-detail-card{background:#fff;border-radius:12px;padding:12px 16px;border:1px solid #fcd34d;display:flex;align-items:center;gap:12px}
.sub-detail-emoji{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.sub-detail-info{flex:1;min-width:0}
.sub-detail-title{font-weight:600;color:#0f172a;font-size:13px;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sub-detail-stars{display:flex;align-items:center;gap:6px;margin-top:4px}
.sub-detail-star{font-size:14px}
.sub-detail-rating-label{font-size:11px;color:#d97706;font-weight:600}
.sub-avg{margin-top:12px;padding:10px 16px;background:#fef3c7;border-radius:10px;display:flex;align-items:center;justify-content:space-between}
.sub-avg-label{color:#92400e;font-size:13px;font-weight:600}
.sub-avg-val{color:#92400e;font-size:18px;font-weight:900}
.loading-state{text-align:center;padding:80px 0;color:#94a3b8;font-size:16px}

/* Responsive */
@media(max-width:640px){
  .welcome-title{font-size:32px}
  .steps-preview{gap:12px}
  .welcome-header,.topnav,.dash-header{padding:12px 16px}
  .dash-inner,.page-inner{padding:16px}
  .stat-value{font-size:22px}
  .project-row-stats{gap:12px}
  .project-stat-val{font-size:18px}
}
</style>
</head>
<body>

<!-- WELCOME -->
<div id="welcome" class="page active">
  <div class="welcome-header">
    <div class="logo">
      <div class="logo-icon">üèÜ</div>
      <div>
        <div class="logo-text">TeamGoals</div>
        <div class="logo-sub">2026 Planning Tool</div>
      </div>
    </div>
    <button class="manager-link" onclick="showManagerLogin()">Manager View</button>
  </div>
  <div class="welcome-hero">
    <div class="welcome-inner">
      <div class="badge"><span>2026 Goal Setting</span></div>
      <h1 class="welcome-title">Shape Your <span class="accent">2026</span> Journey</h1>
      <p class="welcome-desc">Browse this year's proposed key actions, select the ones that excite you, and rate your interest. Your input directly shapes project assignments.</p>
      <div class="steps-preview">
        <div class="step-item"><div class="step-num">1</div><div class="step-label">Browse & Select</div></div>
        <div class="step-item"><div class="step-num">2</div><div class="step-label">Rate Projects</div></div>
        <div class="step-item"><div class="step-num">3</div><div class="step-label">Submit</div></div>
      </div>
      <div class="name-box">
        <label class="name-label">Your Full Name</label>
        <input class="name-input" id="name-input" type="text" placeholder="e.g. Jane Smith" oninput="checkName()" onkeydown="if(event.key==='Enter')startApp()"/>
      </div>
      <button class="btn-primary" id="start-btn" onclick="startApp()" disabled>Get Started ‚Üí</button>
    </div>
  </div>
</div>

<!-- SELECT -->
<div id="select-page" class="page">
  <div class="topnav">
    <div class="nav-logo"><div class="nav-logo-icon">üèÜ</div><span class="nav-logo-text">TeamGoals 2026</span></div>
    <div class="nav-greeting">Hello, <span id="nav-name-select"></span></div>
  </div>
  <div class="page-inner">
    <div id="stepbar-select"></div>
    <div class="page-title">Select Your Projects</div>
    <p class="page-sub">Click on any projects that interest you.</p>
    <button class="select-all-btn" id="select-all-btn" onclick="toggleSelectAll()">Select All</button>
    <div class="projects-grid" id="projects-grid"></div>
  </div>
  <div class="sticky-bar">
    <div class="selected-count"><strong id="selected-count">0</strong><span id="selected-label"> projects selected</span></div>
    <button class="btn-continue" id="continue-btn" onclick="goToRank()" disabled>Continue to Ranking ‚Üí</button>
  </div>
</div>

<!-- RANK -->
<div id="rank-page" class="page">
  <div class="topnav">
    <div class="nav-logo"><div class="nav-logo-icon">üèÜ</div><span class="nav-logo-text">TeamGoals 2026</span></div>
    <div class="nav-greeting">Hello, <span id="nav-name-rank"></span></div>
  </div>
  <div class="page-inner" style="max-width:768px">
    <div id="stepbar-rank"></div>
    <div class="page-title">Rate Your Projects</div>
    <p class="page-sub">Rate your interest from 1 (low) to 5 (high).</p>
    <div class="progress-bar-wrap" style="margin-top:24px">
      <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      <span class="progress-text" id="progress-text">0 of 0 rated</span>
    </div>
    <div class="rating-cards" id="rating-cards"></div>
    <div class="rank-actions">
      <button class="btn-back" onclick="goToSelect()">‚Üê Back</button>
      <button class="btn-submit" id="submit-btn" onclick="submitRatings()" disabled>Submit My Rankings ‚Üí</button>
    </div>
    <p class="rank-hint" id="rank-hint"></p>
  </div>
</div>

<!-- CONFIRM -->
<div id="confirm-page" class="page" style="min-height:100vh;display:none;flex-direction:column;align-items:center;justify-content:center">
  <div class="confirm-inner">
    <div class="confirm-check">‚úì</div>
    <h2 class="confirm-title" id="confirm-title">You're all set!</h2>
    <p class="confirm-desc">Your responses have been saved. Your manager will review all team results and use them to shape project assignments.</p>
    <div id="stepbar-confirm"></div>
    <div class="confirm-list">
      <div class="confirm-list-title">Your Submissions</div>
      <div id="confirm-items"></div>
    </div>
  </div>
</div>

<!-- MANAGER LOGIN -->
<div id="manager-login" class="page" style="min-height:100vh">
  <div class="login-box">
    <div class="login-icon">üîí</div>
    <h2 class="login-title">Manager Access</h2>
    <p class="login-desc">Enter your password to view team results.</p>
    <input class="login-input" id="pw-input" type="password" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()"/>
    <div class="login-error" id="login-error" style="display:none"></div>
    <button class="btn-login" onclick="doLogin()">Access Dashboard</button>
    <button class="btn-back-login" onclick="showPage('welcome')">‚Üê Back</button>
  </div>
</div>

<!-- MANAGER DASHBOARD -->
<div id="manager-dash" class="page">
  <div class="dash-header">
    <div class="dash-logo">
      <div class="dash-logo-icon">üìä</div>
      <div>
        <div class="dash-logo-text">Manager Dashboard</div>
        <div class="dash-logo-sub">2026 Goals ‚Äî Team Results</div>
      </div>
    </div>
    <div class="dash-actions">
      <button class="btn-export" onclick="exportCSV()">‚¨á Export CSV</button>
      <button class="btn-exit" onclick="showPage('welcome')">Exit</button>
    </div>
  </div>
  <div class="dash-inner">
    <div class="stats-grid" id="stats-grid"></div>
    <div id="dash-content"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const JSONBIN_KEY = "$2a$10$4XBuzRlSsNfSfc.xD58ZWOpzy5.av2aeY/PUDckl6JdzIuH2Lnt/u";
const MANAGER_PASSWORD = "manager2026";
let JSONBIN_ID = localStorage.getItem("jsonbin_id_2026") || null;

const PROJECTS = [
  {id:"proj-01",title:"Improve Vehicles Star Ratings",color:"#fef3c7",emoji:"‚≠ê"},
  {id:"proj-02",title:"Vehicles Training & Development (Phase 1)",color:"#e0f2fe",emoji:"üìö"},
  {id:"proj-03",title:"Define & Enforce T&P ICR-CR Process",color:"#f1f5f9",emoji:"üõ°Ô∏è"},
  {id:"proj-04",title:"Revisit PD Process by PDC & Complexity",color:"#ede9fe",emoji:"‚öôÔ∏è"},
  {id:"proj-05",title:"Product Development Innovation",color:"#ffe4e6",emoji:"‚ö°"},
  {id:"proj-06",title:"Value Engineering (VE)",color:"#d1fae5",emoji:"üìà"},
  {id:"proj-07",title:"Community",color:"#fce7f3",emoji:"‚ù§Ô∏è"},
  {id:"proj-08",title:"D3 Parts Library Database",color:"#e0e7ff",emoji:"üóÑÔ∏è"},
  {id:"proj-09",title:"B2E: VC Revamp",color:"#ccfbf1",emoji:"üåê"},
  {id:"proj-10",title:"Refine Handoff Process",color:"#ffedd5",emoji:"üîÑ"},
  {id:"proj-11",title:"Sample Comment Tracking",color:"#ecfccb",emoji:"‚úÖ"},
  {id:"proj-12",title:"Reduce Post-FPR Changes and Tool Modifications",color:"#cffafe",emoji:"üîß"},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userName = "";
let selectedIds = [];
let ratings = {};
let currentSort = "selections";
let expandedSub = null;
let allSubs = [];

// ‚îÄ‚îÄ JSONBIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getOrCreateBin() {
  if (JSONBIN_ID) return JSONBIN_ID;
  const res = await fetch("https://api.jsonbin.io/v3/b", {
    method:"POST",
    headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY,"X-Bin-Name":"2026-goals-submissions","X-Bin-Private":"false"},
    body:JSON.stringify({submissions:[]})
  });
  const data = await res.json();
  JSONBIN_ID = data.metadata.id;
  localStorage.setItem("jsonbin_id_2026", JSONBIN_ID);
  return JSONBIN_ID;
}

async function saveSubmission(name, ratingsArr) {
  const binId = await getOrCreateBin();
  const getRes = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`,{headers:{"X-Master-Key":JSONBIN_KEY}});
  const current = await getRes.json();
  const subs = current.record.submissions || [];
  subs.push({id:Date.now().toString(),employeeName:name,submittedAt:new Date().toISOString(),ratings:ratingsArr});
  await fetch(`https://api.jsonbin.io/v3/b/${binId}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY},body:JSON.stringify({submissions:subs})});
}

async function loadAllSubmissions() {
  const binId = await getOrCreateBin();
  const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`,{headers:{"X-Master-Key":JSONBIN_KEY}});
  const data = await res.json();
  return data.record.submissions || [];
}

async function deleteSubmission(subId) {
  const binId = await getOrCreateBin();
  const getRes = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`,{headers:{"X-Master-Key":JSONBIN_KEY}});
  const current = await getRes.json();
  const subs = (current.record.submissions || []).filter(s => s.id !== subId);
  await fetch(`https://api.jsonbin.io/v3/b/${binId}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY},body:JSON.stringify({submissions:subs})});
  return subs;
}

// ‚îÄ‚îÄ PAGE ROUTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => {
    p.classList.remove('active');
    p.style.display = '';
  });
  const page = document.getElementById(id);
  page.classList.add('active');
  if (id === 'confirm-page' || id === 'manager-login') page.style.display = 'flex';
  window.scrollTo(0,0);
}

// ‚îÄ‚îÄ STEP BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStepBar(containerId, step) {
  const steps = ["Select Projects","Rate Them","Done"];
  const el = document.getElementById(containerId);
  el.className = 'stepbar';
  el.innerHTML = steps.map((s,i) => {
    const state = i+1 < step ? 'done' : i+1 === step ? 'active' : 'inactive';
    const line = i < 2 ? `<div class="step-line ${i+1 < step ? 'done' : 'inactive'}"></div>` : '';
    return `<div style="display:flex;align-items:center;gap:8px">
      <div class="step-pill ${state}">
        <span class="step-dot ${state}">${i+1}</span>${s}
      </div>${line}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkName() {
  const val = document.getElementById('name-input').value.trim();
  document.getElementById('start-btn').disabled = !val;
}

function startApp() {
  userName = document.getElementById('name-input').value.trim();
  if (!userName) return;
  selectedIds = [];
  ratings = {};
  document.getElementById('nav-name-select').textContent = userName;
  renderStepBar('stepbar-select', 1);
  renderProjectGrid();
  showPage('select-page');
}

// ‚îÄ‚îÄ SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProjectGrid() {
  const grid = document.getElementById('projects-grid');
  grid.innerHTML = PROJECTS.map(p => `
    <button class="project-card ${selectedIds.includes(p.id)?'selected':''}" id="card-${p.id}" onclick="toggleProject('${p.id}')">
      <div class="project-emoji" style="background:${p.color}">${p.emoji}</div>
      <span class="project-title">${p.title}</span>
      <div class="project-check ${selectedIds.includes(p.id)?'checked':''}" id="check-${p.id}">${selectedIds.includes(p.id)?'‚úì':''}</div>
    </button>
  `).join('');
  updateSelectionUI();
}

function toggleProject(id) {
  if (selectedIds.includes(id)) {
    selectedIds = selectedIds.filter(x => x !== id);
  } else {
    selectedIds.push(id);
  }
  const card = document.getElementById(`card-${id}`);
  const check = document.getElementById(`check-${id}`);
  const sel = selectedIds.includes(id);
  card.classList.toggle('selected', sel);
  check.classList.toggle('checked', sel);
  check.textContent = sel ? '‚úì' : '';
  updateSelectionUI();
}

function updateSelectionUI() {
  const count = selectedIds.length;
  document.getElementById('selected-count').textContent = count;
  document.getElementById('selected-label').textContent = ` project${count!==1?'s':''} selected`;
  document.getElementById('continue-btn').disabled = count === 0;
  document.getElementById('select-all-btn').textContent = selectedIds.length === PROJECTS.length ? 'Clear All' : 'Select All';
}

function toggleSelectAll() {
  if (selectedIds.length === PROJECTS.length) {
    selectedIds = [];
  } else {
    selectedIds = PROJECTS.map(p => p.id);
  }
  renderProjectGrid();
}

function goToRank() {
  document.getElementById('nav-name-rank').textContent = userName;
  renderStepBar('stepbar-rank', 2);
  renderRatingCards();
  showPage('rank-page');
}

// ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ratingLabels = ["","Low","Below Avg","Average","Above Avg","High Interest"];

function renderRatingCards() {
  const selected = PROJECTS.filter(p => selectedIds.includes(p.id));
  const container = document.getElementById('rating-cards');
  container.innerHTML = selected.map(p => `
    <div class="rating-card ${ratings[p.id]?'rated':''}" id="rcard-${p.id}">
      <div class="rating-card-inner">
        <div class="rating-emoji" style="background:${p.color}">${p.emoji}</div>
        <div class="rating-content">
          <div class="rating-row">
            <h3 class="rating-title">${p.title}</h3>
            <div class="rating-stars">
              <div class="stars" id="stars-${p.id}">
                ${[1,2,3,4,5].map(n => `<button class="star ${n<=(ratings[p.id]||0)?'lit':''}" id="star-${p.id}-${n}"
                  onclick="setRating('${p.id}',${n})"
                  onmouseover="hoverStars('${p.id}',${n})"
                  onmouseout="unhoverStars('${p.id}')">‚òÖ</button>`).join('')}
              </div>
              <span class="rating-label ${ratings[p.id]?'':'empty'}" id="rlabel-${p.id}">${ratings[p.id]?ratingLabels[ratings[p.id]]:'Not yet rated'}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `).join('');
  updateRatingProgress();
}

function hoverStars(pid, n) {
  for (let i=1;i<=5;i++) {
    document.getElementById(`star-${pid}-${i}`).classList.toggle('lit', i<=n);
  }
}

function unhoverStars(pid) {
  const val = ratings[pid] || 0;
  for (let i=1;i<=5;i++) {
    document.getElementById(`star-${pid}-${i}`).classList.toggle('lit', i<=val);
  }
}

function setRating(pid, val) {
  ratings[pid] = val;
  document.getElementById(`rcard-${pid}`).classList.add('rated');
  document.getElementById(`rlabel-${pid}`).textContent = ratingLabels[val];
  document.getElementById(`rlabel-${pid}`).classList.remove('empty');
  for (let i=1;i<=5;i++) {
    document.getElementById(`star-${pid}-${i}`).classList.toggle('lit', i<=val);
  }
  updateRatingProgress();
}

function updateRatingProgress() {
  const selected = PROJECTS.filter(p => selectedIds.includes(p.id));
  const ratedCount = selected.filter(p => ratings[p.id]).length;
  const total = selected.length;
  const pct = total ? (ratedCount/total)*100 : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-text').textContent = `${ratedCount} of ${total} rated`;
  const allDone = ratedCount === total;
  document.getElementById('submit-btn').disabled = !allDone;
  document.getElementById('rank-hint').textContent = allDone ? '' : `Please rate all ${total} selected projects before submitting.`;
}

function goToSelect() { showPage('select-page'); }

async function submitRatings() {
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  const ratingData = selectedIds.map(id => ({
    projectId: id,
    title: PROJECTS.find(p=>p.id===id).title,
    rating: ratings[id]
  }));
  saveSubmission(userName, ratingData).catch(e => console.warn('Save error:', e));
  showConfirm(ratingData);
}

// ‚îÄ‚îÄ CONFIRM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showConfirm(ratingData) {
  document.getElementById('confirm-title').textContent = `You're all set, ${userName.split(' ')[0]}!`;
  renderStepBar('stepbar-confirm', 3);
  const items = document.getElementById('confirm-items');
  const sorted = [...ratingData].sort((a,b) => b.rating - a.rating);
  items.innerHTML = sorted.map(r => {
    const proj = PROJECTS.find(p=>p.id===r.projectId);
    const stars = [1,2,3,4,5].map(n=>`<span class="confirm-star" style="color:${n<=r.rating?'#fbbf24':'#e2e8f0'}">‚òÖ</span>`).join('');
    return `<div class="confirm-item">
      <div class="confirm-item-left">
        <div class="confirm-item-emoji" style="background:${proj.color}">${proj.emoji}</div>
        <span class="confirm-item-title">${r.title}</span>
      </div>
      <div class="confirm-stars">${stars}</div>
    </div>`;
  }).join('');
  showPage('confirm-page');
}

// ‚îÄ‚îÄ MANAGER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showManagerLogin() { showPage('manager-login'); }

function doLogin() {
  const pw = document.getElementById('pw-input').value;
  if (pw === MANAGER_PASSWORD) {
    document.getElementById('login-error').style.display = 'none';
    showPage('manager-dash');
    loadDashboard();
  } else {
    const err = document.getElementById('login-error');
    err.textContent = 'Incorrect password.';
    err.style.display = 'block';
  }
}

async function loadDashboard() {
  document.getElementById('dash-content').innerHTML = '<div class="loading-state">Loading results...</div>';
  document.getElementById('stats-grid').innerHTML = '';
  try {
    allSubs = await loadAllSubmissions();
    renderDashboard();
  } catch(e) {
    document.getElementById('dash-content').innerHTML = '<div class="loading-state">Error loading data. Please try again.</div>';
  }
}

function renderDashboard() {
  const projectStats = PROJECTS.map(p => {
    const selections = allSubs.filter(s => s.ratings.find(r => r.projectId===p.id||r.title===p.title));
    const rated = selections.map(s => s.ratings.find(r=>r.projectId===p.id||r.title===p.title).rating);
    const avg = rated.length ? (rated.reduce((a,b)=>a+b,0)/rated.length).toFixed(1) : null;
    const dist = [1,2,3,4,5].map(n => rated.filter(r=>r===n).length);
    const employees = selections.map(s => s.employeeName);
    return {...p, selections:selections.length, avg, dist, employees};
  });

  const topProject = [...projectStats].sort((a,b)=>b.selections-a.selections)[0];
  const topRated = [...projectStats].filter(p=>p.avg).sort((a,b)=>parseFloat(b.avg)-parseFloat(a.avg))[0];

  // Stats cards
  document.getElementById('stats-grid').innerHTML = [
    {emoji:"üë•",label:"Total Submissions",value:allSubs.length,sub:"team members responded"},
    {emoji:"üèÜ",label:"Most Selected",value:topProject?.selections?`${topProject.selections}x`:"‚Äî",sub:topProject?.title||"No data yet"},
    {emoji:"‚≠ê",label:"Highest Rated",value:topRated?`${topRated.avg} ‚òÖ`:"‚Äî",sub:topRated?.title||"No data yet"},
  ].map(c=>`
    <div class="stat-card">
      <div class="stat-card-top"><div class="stat-icon">${c.emoji}</div><span class="stat-label">${c.label}</span></div>
      <div class="stat-value">${c.value}</div>
      <div class="stat-sub">${c.sub}</div>
    </div>
  `).join('');

  if (allSubs.length === 0) {
    document.getElementById('dash-content').innerHTML = `
      <div class="empty-state">
        <div class="empty-emoji">üì≠</div>
        <h3 class="empty-title">No submissions yet</h3>
        <p class="empty-desc">Share the tool link with your team to start collecting responses.</p>
      </div>`;
    return;
  }

  // Sort projects
  const sorted = [...projectStats].sort((a,b) => currentSort==='selections' ? b.selections-a.selections : parseFloat(b.avg||0)-parseFloat(a.avg||0));

  document.getElementById('dash-content').innerHTML = `
    <div class="section-card" style="margin-bottom:24px">
      <div class="section-header">
        <span class="section-title">Project Results</span>
        <div class="sort-btns">
          <button class="sort-btn ${currentSort==='selections'?'active':''}" onclick="setSort('selections')">By Selections</button>
          <button class="sort-btn ${currentSort==='rating'?'active':''}" onclick="setSort('rating')">By Avg Rating</button>
        </div>
      </div>
      ${sorted.map((p,idx)=>`
        <div class="project-row">
          <div class="project-rank">${idx+1}</div>
          <div class="project-row-emoji" style="background:${p.color}">${p.emoji}</div>
          <div class="project-row-info">
            <div class="project-row-title">${p.title}</div>
            <div class="project-row-employees">${p.employees.join(', ')||'No selections yet'}</div>
            ${p.dist.some(n=>n>0)?`<div class="project-row-dist">${p.dist.map((c,i)=>`<span class="dist-item">‚òÖ${i+1}: ${c}</span>`).join('')}</div>`:''}
          </div>
          <div class="project-row-stats">
            <div class="project-stat"><div class="project-stat-val">${p.selections}</div><div class="project-stat-label">selections</div></div>
            <div class="project-stat"><div class="project-stat-val amber">${p.avg||'‚Äî'}</div><div class="project-stat-label">avg rating</div></div>
          </div>
        </div>
      `).join('')}
    </div>

    <div class="section-card">
      <div class="section-header">
        <span class="section-title">All Submissions <span style="color:#94a3b8;font-weight:400;font-size:13px">‚Äî click a person to see full details</span></span>
      </div>
      ${allSubs.map((s,i)=>{
        const initials = s.employeeName.split(' ').map(n=>n[0]||'').join('').slice(0,2).toUpperCase();
        const sortedRatings = [...s.ratings].sort((a,b)=>b.rating-a.rating);
        const avg = s.ratings.length ? (s.ratings.reduce((a,b)=>a+b.rating,0)/s.ratings.length).toFixed(1) : '‚Äî';
        const subId = s.id || i.toString();
        return `
        <div class="sub-row" id="subrow-${i}">
          <div class="sub-row-header" onclick="toggleSub(${i})" id="subheader-${i}">
            <div class="sub-row-left">
              <div class="sub-avatar">${initials}</div>
              <div>
                <div class="sub-name">${s.employeeName}</div>
                <div class="sub-meta">${new Date(s.submittedAt).toLocaleString()} ¬∑ ${s.ratings.length} project${s.ratings.length!==1?'s':''} rated</div>
              </div>
            </div>
            <div class="sub-row-right">
              <button class="btn-delete" onclick="event.stopPropagation();confirmDelete('${subId}',${i},'${s.employeeName.replace(/'/g,"\\'")}')">üóë Delete</button>
              <span class="sub-arrow" id="arrow-${i}">‚Ä∫</span>
            </div>
          </div>
          <div class="sub-detail" id="subdetail-${i}">
            <div class="sub-detail-grid">
              ${sortedRatings.map(r=>{
                const proj = PROJECTS.find(p=>p.id===r.projectId||p.title===r.title);
                const stars = [1,2,3,4,5].map(n=>`<span class="sub-detail-star" style="color:${n<=r.rating?'#fbbf24':'#e2e8f0'}">‚òÖ</span>`).join('');
                return `<div class="sub-detail-card">
                  <div class="sub-detail-emoji" style="background:${proj?.color||'#f1f5f9'}">${proj?.emoji||'üìå'}</div>
                  <div class="sub-detail-info">
                    <div class="sub-detail-title">${r.title}</div>
                    <div class="sub-detail-stars">${stars}<span class="sub-detail-rating-label">${ratingLabels[r.rating]}</span></div>
                  </div>
                </div>`;
              }).join('')}
            </div>
            <div class="sub-avg">
              <span class="sub-avg-label">Average rating across all selected projects</span>
              <span class="sub-avg-val">${avg} ‚òÖ</span>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function toggleSub(i) {
  const detail = document.getElementById(`subdetail-${i}`);
  const arrow = document.getElementById(`arrow-${i}`);
  const header = document.getElementById(`subheader-${i}`);
  const isOpen = detail.classList.contains('open');
  // Close all
  document.querySelectorAll('.sub-detail').forEach(d=>d.classList.remove('open'));
  document.querySelectorAll('.sub-arrow').forEach(a=>a.classList.remove('open'));
  document.querySelectorAll('.sub-row-header').forEach(h=>h.classList.remove('open'));
  if (!isOpen) {
    detail.classList.add('open');
    arrow.classList.add('open');
    header.classList.add('open');
  }
}

function setSort(val) {
  currentSort = val;
  renderDashboard();
}

function confirmDelete(subId, idx, name) {
  if (!confirm(`Delete submission from "${name}"? This cannot be undone.`)) return;
  doDelete(subId, idx);
}

async function doDelete(subId, idx) {
  try {
    // If id not stored, fall back to index-based deletion
    const binId = await getOrCreateBin();
    const getRes = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`,{headers:{"X-Master-Key":JSONBIN_KEY}});
    const current = await getRes.json();
    let subs = current.record.submissions || [];
    // Try by id first, then by index
    const newSubs = subs.filter((s,i) => s.id !== subId && i !== idx || (s.id && s.id !== subId));
    // Simple approach: remove by index if no id match
    const filtered = subs.filter((s,i) => {
      if (s.id) return s.id !== subId;
      return i !== idx;
    });
    await fetch(`https://api.jsonbin.io/v3/b/${binId}`,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY},body:JSON.stringify({submissions:filtered})});
    allSubs = filtered;
    renderDashboard();
  } catch(e) {
    alert('Error deleting submission. Please try again.');
  }
}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  const now = new Date();
  const dateStr = now.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/\//g,"-");
  const rows = [
    ["2026 GOALS ‚Äî TEAM INTEREST SURVEY RESULTS"],
    [`Exported: ${now.toLocaleString()}`],
    [`Total Submissions: ${allSubs.length}`],
    [],
    ["Employee Name","Submitted At",...PROJECTS.map(p=>p.title)]
  ];
  allSubs.forEach(s => {
    const row = [s.employeeName, new Date(s.submittedAt).toLocaleString(), ...PROJECTS.map(p=>{
      const r = s.ratings.find(x=>x.projectId===p.id||x.title===p.title);
      return r ? r.rating : "‚Äî";
    })];
    rows.push(row);
  });
  // Summary
  rows.push([],[],["PROJECT SUMMARY"],["Project","Total Selections","Avg Rating","1‚òÖ","2‚òÖ","3‚òÖ","4‚òÖ","5‚òÖ","Interested Employees"]);
  PROJECTS.forEach(p => {
    const sels = allSubs.filter(s=>s.ratings.find(r=>r.projectId===p.id||r.title===p.title));
    const rated = sels.map(s=>s.ratings.find(r=>r.projectId===p.id||r.title===p.title).rating);
    const avg = rated.length?(rated.reduce((a,b)=>a+b,0)/rated.length).toFixed(1):"‚Äî";
    const dist = [1,2,3,4,5].map(n=>rated.filter(r=>r===n).length);
    rows.push([p.title,sels.length,avg,...dist,sels.map(s=>s.employeeName).join(", ")]);
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));
  a.download = `2026-goals-results-${dateStr}.csv`;
  a.click();
}
</script>
</body>
</html>
